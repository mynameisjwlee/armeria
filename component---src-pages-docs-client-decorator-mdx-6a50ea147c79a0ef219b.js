(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{"/94A":function(e){e.exports=JSON.parse('{"root":["index","setup"],"References":{"Community articles":"/community/articles","API documentation":"https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/index.html","Release notes":"/release-notes"},"Server":["server-basics","server-decorator","server-grpc","server-thrift","server-docservice","server-annotated-service","server-http-file","server-servlet","server-access-log","server-cors","server-sse","server-service-registration"],"Client":["client-http","client-thrift","client-grpc","client-factory","client-decorator","client-retrofit","client-custom-http-headers","client-timeouts","client-retry","client-circuit-breaker","client-service-discovery"],"Advanced":["advanced-logging","advanced-structured-logging","advanced-custom-attributes","advanced-structured-logging-kafka","advanced-metrics","advanced-unit-testing","advanced-production-checklist","advanced-zipkin","advanced-saml","advanced-spring-webflux-integration","advanced-dropwizard-integration","advanced-scala","advanced-scalapb","advanced-client-interoperability"]}')},xCMr:function(e,t,n){"use strict";var a=n("Wbzz"),r=n("q1tI"),i=n.n(r),c=n("/94A"),o=n("+ejy");t.a=function(e){var t=Object(a.useStaticQuery)("1217743243").allMdx.nodes;return i.a.createElement(o.a,Object.assign({},e,{candidateMdxNodes:t,index:c,prefix:"docs",pageTitleSuffix:"Armeria documentation"}))}},ysAK:function(e,t,n){"use strict";n.r(t),n.d(t,"pageTitle",(function(){return c})),n.d(t,"_frontmatter",(function(){return o})),n.d(t,"default",(function(){return d}));var a=n("zLVn"),r=(n("q1tI"),n("7ljp")),i=n("xCMr"),c="Decorating a client",o={},l={pageTitle:c,_frontmatter:o},p=i.a;function d(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(r.b)(p,Object.assign({},l,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("h1",{id:"decorating-a-client",style:{position:"relative"}},Object(r.b)("a",{parentName:"h1",href:"#decorating-a-client","aria-label":"decorating a client permalink",className:"anchor before"},Object(r.b)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"Decorating a client"),Object(r.b)("h6",{className:"inlinePageToc",role:"navigation"},"Table of contents"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"#implementing-decoratinghttpclientfunction-and-decoratingrpcclientfunction"},"Implementing DecoratingHttpClientFunction and DecoratingRpcClientFunction")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"#extending-simpledecoratinghttpclient-and-simpledecoratingrpcclient"},"Extending SimpleDecoratingHttpClient and SimpleDecoratingRpcClient")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"#the-order-of-decoration"},"The order of decoration")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"#see-also"},"See also"))),Object(r.b)("p",null,"A 'decorating client' (or a 'decorator') is a client that wraps another client to intercept an outgoing\nrequest or an incoming response. As its name says, it is an implementation of ",Object(r.b)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Decorator_pattern"},"the decorator pattern"),".\nClient decoration takes a crucial role in Armeria. A lot of core features such as logging, metrics and\ndistributed tracing are implemented as decorators and you will also find it useful when ",Object(r.b)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Separation_of_concerns"},"separating concerns"),"."),Object(r.b)("p",null,"There are basically two ways to write a decorating client:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"Implementing ",Object(r.b)("a",{parentName:"li",href:"type://DecoratingHttpClientFunction:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/DecoratingHttpClientFunction.html"},"type://DecoratingHttpClientFunction")," and ",Object(r.b)("a",{parentName:"li",href:"type://DecoratingRpcClientFunction:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/DecoratingRpcClientFunction.html"},"type://DecoratingRpcClientFunction")),Object(r.b)("li",{parentName:"ul"},"Extending ",Object(r.b)("a",{parentName:"li",href:"type://SimpleDecoratingClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/SimpleDecoratingClient.html"},"type://SimpleDecoratingClient"))),Object(r.b)("h2",{id:"implementing-decoratinghttpclientfunction-and-decoratingrpcclientfunction",style:{position:"relative"}},Object(r.b)("a",{parentName:"h2",href:"#implementing-decoratinghttpclientfunction-and-decoratingrpcclientfunction","aria-label":"implementing decoratinghttpclientfunction and decoratingrpcclientfunction permalink",className:"anchor before"},Object(r.b)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"Implementing ",Object(r.b)("inlineCode",{parentName:"h2"},"DecoratingHttpClientFunction")," and ",Object(r.b)("inlineCode",{parentName:"h2"},"DecoratingRpcClientFunction")),Object(r.b)("p",null,Object(r.b)("a",{parentName:"p",href:"type://DecoratingHttpClientFunction:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/DecoratingHttpClientFunction.html"},"type://DecoratingHttpClientFunction")," and ",Object(r.b)("a",{parentName:"p",href:"type://DecoratingRpcClientFunction:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/DecoratingRpcClientFunction.html"},"type://DecoratingRpcClientFunction")," are functional interfaces that\ngreatly simplify the implementation of a decorating client.\nThey enable you to write a decorating client with a single lambda expression:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-java"},"import com.linecorp.armeria.common.HttpRequest;\nimport com.linecorp.armeria.common.HttpResponse;\n\nClientBuilder cb = Clients.builder(...);\n...\ncb.decorator((delegate, ctx, req) -> {\n    auditRequest(req);\n    return delegate.execute(ctx, req);\n});\n\nMyService.Iface client = cb.build(MyService.Iface.class);\n")),Object(r.b)("h2",{id:"extending-simpledecoratinghttpclient-and-simpledecoratingrpcclient",style:{position:"relative"}},Object(r.b)("a",{parentName:"h2",href:"#extending-simpledecoratinghttpclient-and-simpledecoratingrpcclient","aria-label":"extending simpledecoratinghttpclient and simpledecoratingrpcclient permalink",className:"anchor before"},Object(r.b)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"Extending ",Object(r.b)("inlineCode",{parentName:"h2"},"SimpleDecoratingHttpClient")," and ",Object(r.b)("inlineCode",{parentName:"h2"},"SimpleDecoratingRpcClient")),Object(r.b)("p",null,"If your decorator is expected to be reusable, it is recommended to define a new top-level class that extends\n",Object(r.b)("a",{parentName:"p",href:"type://SimpleDecoratingHttpClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/SimpleDecoratingHttpClient.html"},"type://SimpleDecoratingHttpClient")," or ",Object(r.b)("a",{parentName:"p",href:"type://SimpleDecoratingRpcClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/SimpleDecoratingRpcClient.html"},"type://SimpleDecoratingRpcClient")," depending on whether\nyou are decorating an ",Object(r.b)("a",{parentName:"p",href:"type://HttpClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/HttpClient.html"},"type://HttpClient")," or an ",Object(r.b)("a",{parentName:"p",href:"type://RpcClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/RpcClient.html"},"type://RpcClient"),":"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-java"},"import com.linecorp.armeria.client.HttpClient;\nimport com.linecorp.armeria.client.SimpleDecoratingHttpClient;\n\npublic class AuditClient extends SimpleDecoratingHttpClient {\n    public AuditClient(HttpClient delegate) {\n        super(delegate);\n    }\n\n    @Override\n    public HttpResponse execute(ClientRequestContext ctx, HttpRequest req) throws Exception {\n        auditRequest(req);\n        return unwrap().execute(ctx, req);\n    }\n}\n\nClientBuilder cb = Clients.builder(...);\n...\n// Using a lambda expression:\ncb.decorator(delegate -> new AuditClient(delegate));\n")),Object(r.b)("h2",{id:"the-order-of-decoration",style:{position:"relative"}},Object(r.b)("a",{parentName:"h2",href:"#the-order-of-decoration","aria-label":"the order of decoration permalink",className:"anchor before"},Object(r.b)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"The order of decoration"),Object(r.b)("p",null,"The decorators are executed in reverse order of the insertion. The following example shows which order\nthe decorators are executed by printing the messages."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-java"},'import com.linecorp.armeria.client.WebClient;\n\nClientBuilder cb = Clients.builder(...);\n\n// #2 decorator\ncb.decorator((delegate, ctx, req) -> {\n    // This is called from #1 decorator.\n    System.err.println("Secondly, executed.");\n    return delegate.execute(ctx, req);\n});\n\n// #1 decorator.\n// No matter decorator() or option() is used, decorators are executed in reverse order of the insertion.\ncb.option(ClientOption.DECORATION, ClientDecoration.of((delegate, ctx, req) -> {\n    System.err.println("Firstly, executed");\n    return delegate.execute(ctx, req); // The delegate, here, is #2 decorator.\n                                       // This will call execute(ctx, req) method on #2 decorator.\n});\n\nWebClient myClient = cb.build(WebClient.class);\n')),Object(r.b)("p",null,"The following diagram describes how an HTTP request and HTTP response are gone through decorators:"),Object(r.b)("span",{className:"remark-draw remark-draw-bob-svg"},Object(r.b)("object",{parentName:"span",data:"/c292b62e7323d09289c8191e1e200129c46b4b5d.svg",role:"img","aria-label":""})),Object(r.b)("p",null,"If the client is a Thrift client and RPC decorators are used, HTTP decorators and RPC decorators are\nseparately grouped and executed in reverse order of the insertion:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-java"},'ClientBuilder cb = Clients.builder(...);\n\n// #2 HTTP decorator.\ncb.decorator((delegate, ctx, httpReq) -> {\n    System.err.println("Fourthly, executed.");\n    ...\n});\n\n// #2 RPC decorator.\ncb.rpcDecorator((delegate, ctx, rpcReq) -> {\n    System.err.println("Secondly, executed.");\n    ...\n});\n\n// #1 HTTP decorator.\ncb.decorator((delegate, ctx, httpReq) -> {\n    System.err.println("Thirdly, executed.");\n    ...\n});\n\n// #1 RPC decorator.\ncb.rpcDecorator((delegate, ctx, rpcReq) -> {\n    System.err.println("Firstly, executed.");\n    ...\n});\n')),Object(r.b)("p",null,"An RPC request is converted into an HTTP request before it's sent to a server.\nTherefore, RPC decorators are applied before the RPC request is converted and HTTP decorators are applied\nafter the request is converted into the HTTP request, as described in the following diagram:"),Object(r.b)("span",{className:"remark-draw remark-draw-bob-svg"},Object(r.b)("object",{parentName:"span",data:"/664010615cb32be07acdef9dbdff3f20f4c03f4c.svg",role:"img","aria-label":""})),Object(r.b)("p",null,"If the decorator modifies the response (e.g. ",Object(r.b)("a",{parentName:"p",href:"type://DecodingClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/encoding/DecodingClient.html"},"type://DecodingClient"),") or spawns more requests\n(e.g. ",Object(r.b)("a",{parentName:"p",href:"type://RetryingClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/retry/RetryingClient.html"},"type://RetryingClient"),"), the outcome may be different depending on the order of the decorators.\nLet's look at the following example that ",Object(r.b)("a",{parentName:"p",href:"type://DecodingClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/encoding/DecodingClient.html"},"type://DecodingClient")," and ",Object(r.b)("a",{parentName:"p",href:"type://ContentPreviewingClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/logging/ContentPreviewingClient.html"},"type://ContentPreviewingClient"),"\nare used together:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-java"},"import com.linecorp.armeria.client.encoding.DecodingClient;\nimport com.linecorp.armeria.client.logging.ContentPreviewingClient;\n\nClientBuilder cb = Clients.builder(...);\ncb.decorator(DecodingClient.newDecorator());\n\n// ContentPreviewingClient should be applied after DecodingClient.\ncb.decorator(ContentPreviewingClient.newDecorator(1000));\n")),Object(r.b)("p",null,Object(r.b)("a",{parentName:"p",href:"type://DecodingClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/encoding/DecodingClient.html"},"type://DecodingClient")," decodes the content of HTTP responses. ",Object(r.b)("a",{parentName:"p",href:"type://ContentPreviewingClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/logging/ContentPreviewingClient.html"},"type://ContentPreviewingClient")," is\n",Object(r.b)("a",{parentName:"p",href:"/docs/advanced-structured-logging#enabling-content-previews"},"Enabling content previews"),"\nof the HTTP response by setting it to the ",Object(r.b)("a",{parentName:"p",href:"type://RequestLog:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/logging/RequestLog.html"},"type://RequestLog"),".\nBecause it's evaluated after ",Object(r.b)("a",{parentName:"p",href:"type://DecodingClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/encoding/DecodingClient.html"},"type://DecodingClient")," from the point of view of an\nHTTP response, which means that the response content is set after it's decoded, you will see the decoded\nresponse content preview. If the two decorators are added in the opposite order, you will get the encoded\npreview because ",Object(r.b)("a",{parentName:"p",href:"type://ContentPreviewingClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/logging/ContentPreviewingClient.html"},"type://ContentPreviewingClient")," is evaluated first for the HTTP response.\nFor ",Object(r.b)("a",{parentName:"p",href:"type://RetryingClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/retry/RetryingClient.html"},"type://RetryingClient"),", please check out\n",Object(r.b)("a",{parentName:"p",href:"/docs/client-retry#retryingclient-with-logging"},Object(r.b)("inlineCode",{parentName:"a"},"RetryingClient")," with logging"),"."),Object(r.b)("h2",{id:"see-also",style:{position:"relative"}},Object(r.b)("a",{parentName:"h2",href:"#see-also","aria-label":"see also permalink",className:"anchor before"},Object(r.b)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},Object(r.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"See also"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"/docs/server-decorator"},"Decorating a service")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"/docs/advanced-custom-attributes"},Object(r.b)("inlineCode",{parentName:"a"},"RequestContext")," custom attributes"))))}d.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-docs-client-decorator-mdx-6a50ea147c79a0ef219b.js.map